
>[Предыдущая статья - часть 1](https://github.com/alx-melnichuk/crm-simple1/blob/master/README.md)

>Статья на английском языке [README.md](https://github.com/alx-melnichuk/crm-simple2/blob/master/README.md)

## Объединить несколько Angular приложений в одно сложное. (часть 2)

### Введение

В предыдущей статье приводится описание как создать каркас приложения на _Angular_, в котором реализуется возможность включить два дополнительных приложения в одно основное. В этой статье продолжим развивать это приложение. Подключим библиотеку _Angular Material_ и организуем работу с активами (с файлами изображений) для каждого дополнительного приложения.

### Предварительные условия

Предварительные условия детально описаны в предыдущей статье.
Укажем кратко:
- _Node.js_ версии 10.9.0 или более поздняя;
- Менеджер пакетов _npm_ версии 6.14.8 или более поздняя;
- _Angular_ версии 10 или более поздняя;

Создать каталог для проекта перейти в него:
```bash
$ mkdir /home/alexey/ws_ts3/crm-simple2/
$ cd /home/alexey/ws_ts3/crm-simple2/
```
Копируем в него файлы проекта из предыдущей статьи [github-crm-simple1](https://github.com/alx-melnichuk/crm-simple1). При этом можно удалить файлы `img-*.png`.

Запустить установку всех требуемых пакетов:
```bash
$ npm install
```
### Добавим _Angular Material_

Библиотека _Angular Material_ содержит много полезных компонент, которые помогут нам создать надежное и красивое приложение. С описанием этой библиотеки можно ознакомится на сайте [https://material.angular.io/](https://material.angular.io/).

Добавим в проект библиотеку _Angular Material_ версии 10, так как был установлен  Angular версии 10.
```bash
$ npx ng add @angular/material@10
```
Во время установки требуется указать тему оформления (например 'Indigo/Pink'). Так как все компоненты этой библиотеки поддерживают тему оформления (одну из предварительно установленных или пользовательскую). И по этому требуется указать тему оформления по умолчанию.

И соглашаемся с установкой библиотеку анимации. Она обеспечит плавную анимацию работы стандартных компонент библиотеки _Angular Material_ (таких как: кнопки, радио-кнопки и так далее). Без анимации не будет корректно работать компонент спинера.

На остальные параметры указываем ответ по умолчанию.

Так как данная библиотека имеет свой набор стилей, то этот набор автоматически добавляется в файл описания проекта.\
_./angular.json_
```json
"styles": [
  "./node_modules/@angular/material/prebuilt-themes/indigo-pink.css",
  "src/styles.scss"
],
```
Библиотека _Angular Material_ потребуется, так как планируется использовать компонент _MatTable_ для отображения таблицы.

Внесем корректировки в шаблон глобальное меню, что бы оно выглядело более красивее.

### Создание сервиса для получения сведений о клиентах.

Для продолжения переходим в каталог компонента `app`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-client/src/app/
```
Для работы с данными о клиентах требуется сервис, который может обращаться к API.

Создадим сервис получения данных о клиентах в отдельном подкаталоге `services`:
```bash
$ mkdir services
$ cd services
$ npx ng generate service client-api
$ cd ..
```
Реализуем в сервисе получение данных по клиентам (например из json-файла).
Данный сервис использует объект класса `HttpClient` и по этому добавим `HttpClientModule` в модуль _/projects/app-client/src/app/app.module.ts_.

### Создание заголовка для отображения списка клиентов.

Приступим к наполнению функционала в дополнительном приложении работы с клиентами. Имеется компонент `client-list`, который соответствует элементу маршрута `/app-client/list`. Добавим ему два дочерних компонента:
- `c-l-header` для отображения заголовка;
- `c-l-middle` для отображения средней части (списка клиентов);

Для продолжения переходим в каталог компонента `client-list`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-client/src/app/client-list/
```
Далее создаем компонент для отображения заголовка в списке клиентов.

Создаем модуль и компонент `c-l-header`:
```bash
$ npx ng generate module c-l-header
$ npx ng generate component c-l-header --export=true
```
Добавим в компонент заголовка `c-l-header` какую-либо картинку, которую можно сопоставить с данным функционалом. Это поможет пользователю интуитивно различать в каком бизнес модуле он находится. Кроме картинки можно добавить какой-либо другой ресурс.

Добавим файл картинки `logo-client.png` в каталог ресурсов текущего дополнительного приложения _'./projects/app-client/src/assets/img'_.

Запустим и проверим работоспособность всего приложения командой:
```bash
$ npx ng serve --port 4250
```
И в браузере проверить по ссылке:  [http://localhost:4250/app-client/list](http://localhost:4250/app-client/list)

Но в требуемом месте нет новой картинки. И в консоли видим ошибку:
```bash
GET http://localhost:4250/assets/img/logo-client.png 404 (Not Found)
```

### Копирование ресурса из дополнительного в основное приложение.

Так как файл картинки был добавлен в ресурсы дополнительного приложения `app-client`, то в ресурсах основного приложения `crm-simple` он отсутствует. А для проверки в браузере запускается основное приложение. Теперь понятно, что ресурсы дополнительного приложения `app-client` должны копироваться каталог ресурсов основного приложения `crm-simple`. Это можно реализовать через настройки `angular.json`.

Добавим копирование файлов ресурсов дополнительного приложения `app-client` в результирующий каталог ресурсов основного приложения `crm-simple`.

Модифицируем файл `angular.json`:\
_/home/alexey/ws_ts3/crm-simple2/angular.json_
```json
{
  "projects": {
    "crm-simple": {
      "architect": {
        "build": {
          "options": {
            "assets": [
              "src/favicon.ico",
              "src/assets",
              {
                "glob": "**/*",
                "input": "projects/app-client/src/assets",
                "output": "/assets"
              }
            ],
```
Об этом можно ознакомиться по ссылке [https://angular.io/guide/workspace-config#asset-config](https://angular.io/guide/workspace-config#asset-config).

Для проверки можно запустить сборку всего приложения командой:
```bash
$ npx ng build
```
По завершении сборки создается каталог `dist`, в котором будут собраны все файлы основного и всех дополнительных приложений. И теперь можно проверить попал файл картинки `logo-client.png` из в каталога ресурсов дополнительного приложения `app-client` в каталог ресурсов основного приложения.

Таким образом имеется возможность добавить в два дополнительных приложения два разных файла с одним именем. Тогда в основной проект попадет тот файл, который будет копироваться последним.

### Копирование ресурса из дополнительного в основное приложение с дополнительным уровнем вложенности.

Для избежания таких конфликтов предлагается простое решение. В каталоге ресурсов `assets`  всех дополнительных приложений добавить еще один каталог (например название данного дополнительного приложения). И перенести в этот новый каталог все требуемые ресурсы (каталог картинок `img` и так далее).

После этого в файле проекта `angular.json` требуется добавить блок для копирования ресурсов каждого дополнительного приложения.

Модифицируем файл `angular.json`:\
_/home/alexey/ws_ts3/crm-simple2/angular.json_
```json
{
  "projects": {
    "crm-simple": {
      "architect": {
        "build": {
          "options": {
            "assets": [
              "src/favicon.ico",
              "src/assets",
              {
                "glob": "**/*",
                "input": "projects/app-client/src/assets/app-client",
                "output": "/assets/app-client"
              }
            ],
```
Такую структуру каталога ресурсов `/assets/app-client` требуется учитывать и при использовании этих файлов.
Например, для использования картинки `logo-client.png` требуется указать:
```html
background: url("/assets/app-client/img/logo-client.png")
```
Данный подход исключает конфликт при добавлении в два дополнительных приложения два разных файла с одним именем. И разработчики не будут тратить свое время на решение проблем такого рода. Это метод позволяет создавать независимые дополнительные приложения, которые содержат в своем составе все требуемые для своей работы ресурсы.

Если случится дублирование файла ресурсов в разных дополнительных приложениях - это ни на что не повлияет. Каждый бизнес модуль загружается ленивой загрузкой и в любой момент времени будет загружен только один бизнес модуль.

Когда изначально планируется использовать файл ресурса в двух дополнительных приложениях, то имеет смысл перенести этот файл ресурса в дополнительную библиотеку. И затем подключить эту библиотеку в каждый бизнес модуль. Так же требуется добавить в `angular.json` копирование ресурсов этой библиотеки в основное приложение (как описано выше).

### Создание средней части для отображения списка клиентов.

Для продолжения переходим в каталог дополнительного приложения `app-client`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-client/src/app/client-list/
```
Ранее был создан компонент `c-l-header` для отображения заголовка. Далее создаем компонент для отображения средней части `c-l-middle`.

Создаем модуль и компонент `c-l-middle`:
```bash
$ npx ng generate module c-l-middle
$ npx ng generate component c-l-middle --export=true
```
Добавим в данный компонент отображение списка клиентов.

### Создание заголовка для отображения свойств клиента.

Продолжим наполнение функционала в дополнительном приложении работы с клиентами. Имеется компонент `client-view`, который соответствует элементу маршрута `/app-client/view`. В данном компоненте будут отображаются свойства одного выбранного клиента.

Для получения свойств клиента требуется вызвать метод сервиса _ClientApiService.getData()_. Предположим, что в компоненте заголовка требуется указать название клиента, а компоненте средней части - все остальные свойства клиента. Таким образом метод _ClientApiService.getData()_ будет вызываться в двух этих компонентах. Перед тем как вызывать этот метод, требуется определить идентификатор клиента из параметров маршрута. Для этого организовывается подписка на получение данных маршрута. И так как эти данные требуются в двух компонентах, то подписка должна быть организована то же в двух компонентах. Если выполняется подписка на событие, то следует не забыть выполнить отписку от этого события.

Более рациональным решением является вынести организацию подписки/отписки, получение общих данных на уровень родительского компонента. Вывод: основная задача компонента, связанного с маршрутом - получение всех данных для своих дочерних элементов. И все эти данные будут передаваться через входные параметры дочерних компонент. Таким образом эти дочерние компоненты можно легко использовать в других места, когда это понадобится.

Для продолжения переходим в каталог компонента `client-view`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-client/src/app/client-view/
```
Далее создаем компонент для отображения заголовка.

Создаем модуль и компонент `c-v-header`:
```bash
$ npx ng generate module c-v-header
$ npx ng generate component c-v-header --export=true
```
Реализуем компонент заголовка _c-v-header_ аналогично компоненту описанному выше _c-l-header_. И добавим ссылку для возможности вернуться на список клиентов.

### Создание средней части для отображения свойств клиента.

Создаем компонент для отображения средней части `c-v-middle`.

Создаем модуль и компонент `c-v-middle`:
```bash
$ npx ng generate module c-v-middle
$ npx ng generate component c-v-middle --export=true
```
Добавим в данный компонент отображение свойств клиента.

Теперь можно удалить компонент навигации дополнительного приложения, так как он больше не используется _/projects/app-client/src/app/nav/_.

Запустим и проверим как работает дополнительное приложение `app-client`:
```bash
$ npx ng serve --port 4250
```
И проверить в браузере отображение списка клиентов по ссылке:  [http://localhost:4250/app-client/list](http://localhost:4250/app-client/list)

![alt](https://github.com/alx-melnichuk/crm-simple2/blob/master/img2-client-list.png)

И проверить в браузере отображение свойств клиента по ссылке:  [http://localhost:4250/app-client/view/1](http://localhost:4250/app-client/view/1)

![alt](https://github.com/alx-melnichuk/crm-simple2/blob/master/img2-client-view.png)

### Создание сервиса для получения сведений о задачах.

Проделаем аналогичную работу в дополнительном приложении работы с задачами.

Для продолжения переходим в каталог дополнительного приложения `app-task`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-task/
```
Дополнительное приложение по работе с задачами предоставляет пользователю следующие возможности:
- просмотреть список задач;
- просмотреть свойства отдельной задачи;

Для продолжения переходим в каталог компонента `app`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-task/src/app/
```
Для работы с данными о задачах требуется сервис, который может обращаться к API.

Создадим сервис получения данных о задачах в отдельном подкаталоге `services`:
```bash
$ mkdir services
$ cd services
$ npx ng generate service task-api
$ cd ..
```
Реализуем в сервисе получение данных по задачах (например из json-файла).

### Создание заголовка для отображения списка задач.

В дополнительном приложении работы с задачами имеется компонент `task-list`, который соответствует элементу маршрута `/app-task/list`. Добавим ему два дочерних компонента:
- `t-l-header` для отображения заголовка;
- `t-l-middle` для отображения средней части (списка задач);

Для продолжения переходим в каталог компонента `task-list`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-task/src/app/task-list/
```
Далее создаем компонент для отображения заголовка в списке задач.

Создаем модуль и компонент `t-l-header`:
```bash
$ npx ng generate module t-l-header
$ npx ng generate component t-l-header --export=true
```
Добавим в компонент заголовка `t-l-header` соответствующую картинку. Файл этой картинки `logo-task.png` поместим в каталог ресурсов текущего дополнительного приложения _'./projects/app-task/src/assets/app-task/img'_.

### Создание средней части для отображения списка задач.

Создаем модуль и компонент `t-l-middle`:
```bash
$ npx ng generate module t-l-middle
$ npx ng generate component t-l-middle --export=true
```
Добавим в данный компонент отображение списка задач.

Так же в файле проекта `angular.json` добавляем блок для копирования ресурсов данного дополнительного приложения.

Модифицируем файл `angular.json`:\
_/home/alexey/ws_ts3/crm-simple2/angular.json_
```json
{
  "projects": {
    "crm-simple": {
      "architect": {
        "build": {
          "options": {
            "assets": [
              "src/favicon.ico",
              "src/assets",
              {
                "glob": "**/*",
                "input": "projects/app-client/src/assets/app-client",
                "output": "/assets/app-client"
              },
              {
                "glob": "**/*",
                "input": "projects/app-task/src/assets/app-task",
                "output": "/assets/app-task"
              }
            ],
```
### Создание заголовка для отображения свойств задачи.

Продолжим наполнение функционала в дополнительном приложении работы с задачами. Имеется компонент `task-view`, который соответствует элементу маршрута `/app-task/view`. В данном компоненте будут отображаются свойства одной выбранной задачи.
Главная задача данного компонента - подготовить все данные для своих дочерних компонент.

Для продолжения переходим в каталог компонента `task-view`:
```bash
$ cd /home/alexey/ws_ts3/crm-simple2/projects/app-task/src/app/task-view/
```
Далее создаем компонент для отображения заголовка.

Создаем модуль и компонент `t-v-header`:
```bash
$ npx ng generate module t-v-header
$ npx ng generate component t-v-header --export=true
```
Реализуем компонент заголовка `t-v-header` аналогично компоненту описанному выше `t-l-header`. И добавим ссылку для возможности вернуться на список задач.

### Создание средней части для отображения свойств задачи.

Создаем компонент для отображения средней части `t-v-middle`.

Создаем модуль и компонент `t-v-middle`:
```bash
$ npx ng generate module t-v-middle
$ npx ng generate component t-v-middle --export=true
```
Добавим в данный компонент отображение свойств текущей задачи.

Теперь можно удалить компонент навигации дополнительного приложения, так как он больше не используется _/projects/app-task/src/app/nav/_.

Запустим и проверим как работает дополнительное приложение `app-client`:
```bash
$ npx ng serve --port 4250
```
И проверить в браузере отображение списка задач по ссылке: [http://localhost:4250/app-task/list](http://localhost:4250/app-task/list)

![alt](https://github.com/alx-melnichuk/crm-simple2/blob/master/img2-task-list.png)

И проверить в браузере отображение свойств задачи по ссылке: [http://localhost:4250/app-task/view/1](http://localhost:4250/app-task/view/1)

![alt](https://github.com/alx-melnichuk/crm-simple2/blob/master/img2-task-view.png)

На выходе получилось приложение, которое состоит из двух не связанных дополнительных приложений:
- по работе с клиентами `app-client`;
- по работе с задачами `app-task`;

Каждое дополнительное приложение имеет свои активы, которые не пересекаются между собой.

Исходный код можно скачать [github-crm-simple2](https://github.com/alx-melnichuk/crm-simple2). (Запустите  `npm install` перед запуском приложения.)

Запустить проект на сайте StackBlitz можно по ссылке [https://stackblitz.com/github/alx-melnichuk/crm-simple2](https://stackblitz.com/github/alx-melnichuk/crm-simple2)

При старте проекта на сайте StackBlitz в браузере _Google Chrome_ версии 84 возникла ошибка:
```
ERROR: Cross-origin localStorage blocked by browser but required for devserver.
Please enable 3rd party cookies or add an exception for stackblitz.io to resolve.
```
Решение описано в статье: [https://github.com/stackblitz/core/issues/162](https://github.com/stackblitz/core/issues/162)
Чтобы не включать 3-й части cookies по всему миру, можно добавить в исключения _stackblitz.io_:
```
-> chrome://settings/content/cookies
-> Allow -> Add:
[*.]stackblitz.io
```

### Анализ полученного результата

В результате проделанной работы имеем следующие выводы:

- ресурсы всех дополнительных приложений должны копироваться в каталог ресурсов основного приложения (реализуется через настройки `angular.json`);
- все файлы ресурсов дополнительного приложения должны иметь дополнительный подкаталог. На пример наименование дополнительного приложения (`/assets/<name-application>/`). Это позволит избежать конфликтов с другими дополнительными приложениями при  при сборке в каталог ресурсов основного приложения.
- в компоненте, который связан с маршрутом, определяются данные (из маршрута и других источников) и передаются в дочерние компоненты через входные параметры;

